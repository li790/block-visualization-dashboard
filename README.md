# 运营成本管理看板

基于 Streamlit 构建的运营成本管理可视化系统，支持多项目数据分析和对比。

## 功能特性

- 📁 **文件管理**: 支持上传新Excel文件或选择现有文件
- 📋 **表格提取**: 支持从Excel文件中提取特定工作表并只保留前39行数据
- 📊 **数据可视化**: 饼图、柱状图、折线图等多种图表展示
- 📈 **KPI指标**: 年使用率、月累使用率、时间进度等关键指标
- 🔄 **多项目对比**: 支持多个项目的横向对比分析
- 📥 **数据导出**: 支持汇总表下载
- 🎨 **现代化UI**: 采用苹果风格卡片设计，横向排列的关键指标
- 🔗 **多项目合并**: 支持多个项目数据合并计算，显示统一的合并指标
- 🍩 **三环甜甜圈图**: 独立的3个甜甜圈图显示时间进度、年使用率、月累使用率
- 🗂️ **缓存管理**: 智能缓存管理，缓解内存压力，支持一键清理缓存文件

## 项目结构

```
区块级可视化图/
├── main.py                 # 主应用入口
├── requirements.txt        # 依赖包列表
├── README.md              # 项目说明
├── utils/                 # 工具模块
│   ├── data_processor.py  # 数据处理
│   └── chart_creator.py   # 图表创建
├── components/            # 组件模块
│   ├── sidebar.py         # 侧边栏组件
│   └── dashboard.py       # 仪表盘组件
├── data/                  # 数据目录
│   └── *.xlsx            # Excel文件
└── output/                # 输出目录
    ├── buffer/            # 缓冲文件目录
    └── analysis_results/  # 分析结果目录
```

## 安装和运行

1. **安装依赖**:
   ```bash
   pip install -r requirements.txt
   ```

2. **运行应用**:
   ```bash
   streamlit run main.py
   ```

3. **访问应用**:
   打开浏览器访问 http://localhost:8501

## Excel文件格式要求

Excel文件应包含以下列结构：
- 第1列：二级费项名称
- 第2列：数据类型（目标金额/已发生金额等）
- 第3-14列：1-12月数据

关键行标识：
- 包含"总成本"或"年总成本"的行
- 包含"月累总目标成本"的行
- 包含"月累已发生成本"的行
- 各二级费项的"目标金额"和"已发生金额"行

## 使用说明

1. **缓存管理**: 在侧边栏可以查看缓存文件统计，支持一键清理所有缓存文件
2. **上传文件**: 在侧边栏使用相应的上传通道:
   - **需提取表格的文件上传**: 上传需要提取特定工作表前39行数据的Excel文件
3. **选择文件**: 从data目录中选择现有文件进行分析
4. **选择月份**: 选择要分析的月份（1-12月）
5. **查看分析**: 系统自动生成图表和指标
6. **下载报告**: 多项目时可下载汇总表
7. **多项目模式**: 选择多个项目时，系统会自动合并数据并显示统一的合并指标

### 缓存管理说明

- **缓冲文件**: 上传的文件会临时保存到 `output/buffer/` 目录进行处理
- **分析结果**: 处理后的分析结果保存到 `output/analysis_results/` 目录
- **自动清理**: 处理完成后会自动清理临时缓冲文件
- **手动清理**: 可以通过侧边栏的"清理所有缓存"按钮手动清理所有缓存文件
- **内存优化**: 通过文件缓冲机制减少内存占用，提高大文件处理性能

### 显示模式说明

- **单项目模式**: 显示3个独立的甜甜圈图（时间进度、年使用率、月累使用率）和紧凑的金额指标卡片
- **多项目模式**: 显示3个独立的甜甜圈图、紧凑的金额指标卡片，以及详细的项目对比分析、图表控制、数据下载等功能
- **项目选择**: 多项目模式下可以选择特定项目进行详细分析

## UI设计特色

### 苹果风格卡片设计
- **关键指标卡片**: 采用渐变背景和圆角设计
- **紧凑布局**: 3个金额指标横向排列，节省空间
- **悬停效果**: 鼠标悬停时卡片会轻微上浮
- **响应式布局**: 适配不同屏幕尺寸

### 三环甜甜圈图设计
- **独立显示**: 3个独立的甜甜圈图分别显示不同指标
- **进度可视化**: 时间进度、年使用率、月累使用率
- **中心数值**: 每个甜甜圈图中心显示具体数值和单位
- **颜色区分**: 使用不同深浅的蓝色区分各个指标

### 视觉层次
- **项目标题**: 清晰的项目名称显示
- **指标分组**: 相关指标分组显示
- **颜色搭配**: 蓝紫色渐变，专业且现代

## 技术栈

- **后端**: Streamlit
- **数据处理**: Pandas, NumPy
- **图表**: Plotly
- **文件处理**: openpyxl
- **UI设计**: CSS3 + HTML5

## 开发说明

- `main.py`: 应用入口，整合所有模块
- `utils/data_processor.py`: 数据处理逻辑，包含缓存管理功能
- `utils/chart_creator.py`: 图表生成函数，包含create_three_donut_charts函数
- `components/dashboard.py`: 仪表盘组件，支持单项目和多项目模式
- `components/sidebar.py`: 侧边栏组件，包含文件管理和缓存管理功能



### 布局改进详情
1. **三环甜甜圈图**: 
   - 时间进度：显示当前月份相对于全年的进度百分比
   - 年使用率：显示年度成本使用率
   - 月累使用率：显示月度累计使用率

2. **紧凑金额指标**:
   - 使用3列布局显示年累计目标、年累计已发生、月累目标
   - 减小卡片尺寸，优化空间利用
   - 保持苹果风格的渐变效果和悬停动画

3. **响应式设计**:
   - 适配不同屏幕尺寸
   - 保持图表的完整性和可读性
