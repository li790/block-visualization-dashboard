# 运营成本管理看板

基于 Streamlit 的多项目运营成本可视化系统，支持多维度数据分析、对比与导出。

## 功能特性

- 📁 **文件管理**: 支持Excel文件上传、批量选择、重命名、删除
- 📋 **表格提取**: 自动提取Excel特定工作表，支持主要/三级费项切换
- 📊 **数据可视化**: 饼图、柱状图、折线图、三环甜甜圈等
- 📈 **KPI指标**: 年使用率、月累使用率、时间进度等
- 🔄 **多项目对比**: 支持多项目横向对比与合并分析
- 📥 **数据导出**: 支持各类分析结果和汇总表下载



## 项目结构

```
区块级可视化图/
├── main.py                 # 主应用入口
├── requirements.txt        # 依赖包列表
├── utils/                 # 工具模块
│   ├── data_processor.py  # 数据处理
│   └── chart_creator.py   # 图表创建
├── components/            # 组件模块
│   ├── sidebar.py         # 侧边栏组件
│   └── dashboard.py       # 仪表盘组件
├── data/                  # 数据目录
│   └── *.xlsx            # Excel文件
└── output/                # 输出目录
    ├── buffer/            # 缓冲文件
    ├── analysis_results/  # 分析结果
    └── processed_data/    # 处理后数据
```

## 安装和运行

1. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
2. 运行应用：
   ```bash
   streamlit run main.py
   ```
3. 访问 http://localhost:8501

## Excel文件格式要求

- 第1列：二级费项名称
- 第2列：数据类型（目标金额/已发生金额等）
- 第3-14列：1-12月数据
- 关键行：包含"总成本""年总成本""月累总目标成本""月累已发生成本"及各二级费项的目标/已发生金额

## 使用说明

- 侧边栏支持文件上传、选择、缓存管理
- 可切换"包含自有人工成本"以调整主要费项表格
- 支持多项目选择与合并分析
- 自动生成图表与指标，支持导出
- 异常项自动检测与高亮



## 技术栈

- **后端**: Streamlit
- **数据处理**: Pandas, NumPy
- **图表**: Plotly
- **文件处理**: openpyxl
- **UI**: CSS3 + HTML5

## 开发说明

- `main.py`: 应用入口
- `utils/data_processor.py`: 数据处理与缓存
- `utils/chart_creator.py`: 图表生成
- `components/dashboard.py`: 仪表盘
- `components/sidebar.py`: 侧边栏

## 最新更新

### v3.8 - 人工服务拆分图表优化与错误修复

- **人工服务拆分功能增强**: 
  - 保留人工服务拆分汇总表，支持多项目数据合并
  - 新增人工服务拆分图表分析功能
  - 只绘制三个汇总费项：自有人员汇总、专业外包汇总、劳务派遣汇总
  - 每个费项包含已发生金额（柱状图）和目标金额（折线图）
  - 使用指定颜色：自有人员汇总（橙色）、专业外包汇总（绿色）、劳务派遣汇总（蓝色）
  - 在多项目分析中，人工服务拆分汇总数据模块移到主控费项异常监控之上
  - 保留表格样式优化和下载功能

- **错误修复**: 
  - 修复了Styler.applymap弃用警告，替换为map方法
  - 解决了pandas版本兼容性问题
  - 优化了图表显示效果，折线图使用虚线样式和菱形标记

### v3.7 - 错误修复与数据稳定性增强

- **修复排行榜错误**: 解决了"invalid literal for int() with base 10: '12月'"错误
  - 增强了月份参数的类型转换逻辑，支持处理"12月"等字符串格式
  - 添加了正则表达式提取数字部分的功能
  - 在异常数据统计中增加了字符串月份的处理

- **修复数据类型错误**: 解决了"ufunc 'add' did not contain a loop with signature matching types"错误
  - 在`process_excel_data`函数中添加了`safe_convert_to_float`函数
  - 安全地将Excel中的字符串数据转换为数值类型
  - 处理包含"12月"、"N/A"等字符串的单元格数据
  - 确保numpy的cumsum操作不会因为混合数据类型而失败

- **数据稳定性改进**:
  - 增强了Excel数据提取的容错性
  - 改进了异常检测逻辑的数据类型处理
  - 确保所有数值计算操作的数据类型一致性

### v3.6 - 人工服务拆分功能

- 新增人工服务拆分数据提取功能
- 支持从Excel文件中提取人工服务拆分工作表（前130行）
- 多项目情况下自动累加1-12月数据生成汇总表
- 在仪表盘最后展示人工服务拆分汇总表格
- 支持下载人工服务拆分数据

### v3.1 - 功能与界面增强

- 主要费项表格切换：侧边栏新增"包含自有人工成本"开关
- 保存全部和部分文件代码修改
---